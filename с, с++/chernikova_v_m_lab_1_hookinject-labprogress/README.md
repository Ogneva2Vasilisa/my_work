## **Задача:** 
В рамках выполнения лабораторной работы необходимо разработать программу и dll-библиотеку, которые обеспечивают два режима работы:
 1. Отслеживание вызов указанных заранее функций. Каждый вызов функции в целевом процессе должен сопровождаться печатью сообщения на консоль разрабатываемой программы. Распечатанное сообщение должно содержать имя функции и метку времени.
2. Изменение поведение функции FindFirstFile, FindNextFile, CreateFile таким образом, что для целевого процесса пропадает указанный заранее файл. Для изменения поведения достаточно изменять значения, возвращаемые этими функциями в соответствии с определенными входными параметрами.
### Анализ работы
Для того, чтобы отслеживать вызовы функций из kernel32, в целевой процесс будет загружаться dll, которая будет патчить инструкции по адресу вызова функции.

Для загрузки своей dll в сторонний процесс была написана программа Injector, которая записывает в целевой процесс путь к dll, а затем создает отдельный поток, который подгрузит dll в процесс с помощью функции LoadLibraryA. Код можно видеть на рисунке 1.

_Рисунок_ _1_ _- Код инжектора_
![](../../img/Pasted%20image%2020250619013836.png)

Для общения dll и программы-инжектора в них были прописаны классы PiperCl и Piper, которые создают именованный канал и пересылают по нему сообщения. С помощью него в dll передается информация, какие функции нужно отслеживать и какой файл необходимо скрыть.

Для патчинга был разработан класс HookPatch, он хранит функции, которые были пропатченны, а также их адреса. Функция принимает на вход адрес функции мониторинга и название функции из kernel32. Далее находит в kernel32 адрес функции и заменяет байты по этому адресу на переход на мою функцию, которая сохраняет все аргументы на стеке, затем переключается на функцию мониторинга, после чего достает аргументы и переносится на оригинальную функцию.

Также для фиксирования, какая именно функция была вызвана, я кладу на стек номер данной функции, который затем берется со стека и подается на вход в функцию мониторинга.

Для скрытия файла была написана отдельная функция, которая помимо мониторинга включает сравнение входной строки и в зависимости от результатов сравнения переключается или не переключается на оригинальную функцию.

Протестируем программу на notepad.exe. Тесты представлены на рисунках 2 и 3.

_Рисунок_ _2_ _-_ _Мониторинг вызовов_
![](../../img/Pasted%20image%2020250619013847.png)

_Рисунок_ _3_ _-_ _Сокрытие файла_
![](../../img/Pasted%20image%2020250619013854.png)